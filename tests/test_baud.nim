import ../src/avr_io/private/usart

import unittest
import macros


macro baudTests(): untyped =
  const test_cases = [
    # Table 19-9: f_osc = 1.0000MHz
    (1_000_000, 2400,    AsyncNormal, 25'u16),
    (1_000_000, 4800,    AsyncNormal, 12'u16),
    (1_000_000, 9600,    AsyncNormal, 6'u16),
    (1_000_000, 14400,   AsyncNormal, 3'u16),
    (1_000_000, 19200,   AsyncNormal, 2'u16),
    (1_000_000, 28800,   AsyncNormal, 1'u16),
    (1_000_000, 38400,   AsyncNormal, 1'u16),
    (1_000_000, 57600,   AsyncNormal, 0'u16),
    (1_000_000, 2400,    AsyncDouble, 51'u16),
    (1_000_000, 4800,    AsyncDouble, 25'u16),
    (1_000_000, 9600,    AsyncDouble, 12'u16),
    (1_000_000, 14400,   AsyncDouble, 8'u16),
    (1_000_000, 19200,   AsyncDouble, 6'u16),
    (1_000_000, 28800,   AsyncDouble, 3'u16),
    (1_000_000, 38400,   AsyncDouble, 2'u16),
    (1_000_000, 57600,   AsyncDouble, 1'u16),
    (1_000_000, 76800,   AsyncDouble, 1'u16),
    (1_000_000, 115200,  AsyncDouble, 0'u16),

    # Table 19-9: f_osc = 1.8432MHz
    (1_843_200, 2400,    AsyncNormal, 47'u16),
    (1_843_200, 4800,    AsyncNormal, 23'u16),
    (1_843_200, 9600,    AsyncNormal, 11'u16),
    (1_843_200, 14400,   AsyncNormal, 7'u16),
    (1_843_200, 19200,   AsyncNormal, 5'u16),
    (1_843_200, 28800,   AsyncNormal, 3'u16),
    (1_843_200, 38400,   AsyncNormal, 2'u16),
    (1_843_200, 57600,   AsyncNormal, 1'u16),
    (1_843_200, 76800,   AsyncNormal, 1'u16),
    (1_843_200, 115200,  AsyncNormal, 0'u16),
    (1_843_200, 2400,    AsyncDouble, 95'u16),
    (1_843_200, 4800,    AsyncDouble, 47'u16),
    (1_843_200, 9600,    AsyncDouble, 23'u16),
    (1_843_200, 14400,   AsyncDouble, 15'u16),
    (1_843_200, 19200,   AsyncDouble, 11'u16),
    (1_843_200, 28800,   AsyncDouble, 7'u16),
    (1_843_200, 38400,   AsyncDouble, 5'u16),
    (1_843_200, 57600,   AsyncDouble, 3'u16),
    (1_843_200, 76800,   AsyncDouble, 2'u16),
    (1_843_200, 115200,  AsyncDouble, 1'u16),
    (1_843_200, 230400,  AsyncDouble, 0'u16),

    # Table 19-9: f_osc = 2.0000MHz
    (2_000_000, 2400,    AsyncNormal, 51'u16),
    (2_000_000, 4800,    AsyncNormal, 25'u16),
    (2_000_000, 9600,    AsyncNormal, 12'u16),
    (2_000_000, 14400,   AsyncNormal, 8'u16),
    (2_000_000, 19200,   AsyncNormal, 6'u16),
    (2_000_000, 28800,   AsyncNormal, 3'u16),
    (2_000_000, 38400,   AsyncNormal, 2'u16),
    (2_000_000, 57600,   AsyncNormal, 1'u16),
    (2_000_000, 76800,   AsyncNormal, 1'u16),
    (2_000_000, 115200,  AsyncNormal, 0'u16),
    (2_000_000, 2400,    AsyncDouble, 103'u16),
    (2_000_000, 4800,    AsyncDouble, 51'u16),
    (2_000_000, 9600,    AsyncDouble, 25'u16),
    (2_000_000, 14400,   AsyncDouble, 16'u16),
    (2_000_000, 19200,   AsyncDouble, 12'u16),
    (2_000_000, 28800,   AsyncDouble, 8'u16),
    (2_000_000, 38400,   AsyncDouble, 6'u16),
    (2_000_000, 57600,   AsyncDouble, 3'u16),
    (2_000_000, 76800,   AsyncDouble, 2'u16),
    (2_000_000, 115200,  AsyncDouble, 1'u16),
    (2_000_000, 250000,  AsyncDouble, 0'u16),

    # Table 19-10: f_osc = 3.6864MHz
    (3_686_400, 2400,    AsyncNormal, 95'u16),
    (3_686_400, 4800,    AsyncNormal, 47'u16),
    (3_686_400, 9600,    AsyncNormal, 23'u16),
    (3_686_400, 14400,   AsyncNormal, 15'u16),
    (3_686_400, 19200,   AsyncNormal, 11'u16),
    (3_686_400, 28800,   AsyncNormal, 7'u16),
    (3_686_400, 38400,   AsyncNormal, 5'u16),
    (3_686_400, 57600,   AsyncNormal, 3'u16),
    (3_686_400, 76800,   AsyncNormal, 2'u16),
    (3_686_400, 115200,  AsyncNormal, 1'u16),
    (3_686_400, 230400,  AsyncNormal, 0'u16),
    (3_686_400, 250000,  AsyncNormal, 0'u16),
    (3_686_400, 2400,    AsyncDouble, 191'u16),
    (3_686_400, 4800,    AsyncDouble, 95'u16),
    (3_686_400, 9600,    AsyncDouble, 47'u16),
    (3_686_400, 14400,   AsyncDouble, 31'u16),
    (3_686_400, 19200,   AsyncDouble, 23'u16),
    (3_686_400, 28800,   AsyncDouble, 15'u16),
    (3_686_400, 38400,   AsyncDouble, 11'u16),
    (3_686_400, 57600,   AsyncDouble, 7'u16),
    (3_686_400, 76800,   AsyncDouble, 5'u16),
    (3_686_400, 115200,  AsyncDouble, 3'u16),
    (3_686_400, 230400,  AsyncDouble, 1'u16),
    (3_686_400, 250000,  AsyncDouble, 1'u16),
    (3_686_400, 500000,  AsyncDouble, 0'u16),

    # Table 19-10: f_osc = 4.0000MHz
    (4_000_000, 2400,    AsyncNormal, 103'u16),
    (4_000_000, 4800,    AsyncNormal, 51'u16),
    (4_000_000, 9600,    AsyncNormal, 25'u16),
    (4_000_000, 14400,   AsyncNormal, 16'u16),
    (4_000_000, 19200,   AsyncNormal, 12'u16),
    (4_000_000, 28800,   AsyncNormal, 8'u16),
    (4_000_000, 38400,   AsyncNormal, 6'u16),
    (4_000_000, 57600,   AsyncNormal, 3'u16),
    (4_000_000, 76800,   AsyncNormal, 2'u16),
    (4_000_000, 115200,  AsyncNormal, 1'u16),
    (4_000_000, 230400,  AsyncNormal, 0'u16),
    (4_000_000, 2400,    AsyncDouble, 207'u16),
    (4_000_000, 4800,    AsyncDouble, 103'u16),
    (4_000_000, 9600,    AsyncDouble, 51'u16),
    (4_000_000, 14400,   AsyncDouble, 34'u16),
    (4_000_000, 19200,   AsyncDouble, 25'u16),
    (4_000_000, 28800,   AsyncDouble, 16'u16),
    (4_000_000, 38400,   AsyncDouble, 12'u16),
    (4_000_000, 57600,   AsyncDouble, 8'u16),
    (4_000_000, 76800,   AsyncDouble, 6'u16),
    (4_000_000, 115200,  AsyncDouble, 3'u16),
    (4_000_000, 230400,  AsyncDouble, 1'u16),
    (4_000_000, 250000,  AsyncDouble, 1'u16),
    (4_000_000, 500000,  AsyncDouble, 0'u16),

    # Table 19-10: f_osc = 7.3728MHz
    (7_372_800, 2400,    AsyncNormal, 191'u16),
    (7_372_800, 4800,    AsyncNormal, 95'u16),
    (7_372_800, 9600,    AsyncNormal, 47'u16),
    (7_372_800, 14400,   AsyncNormal, 31'u16),
    (7_372_800, 19200,   AsyncNormal, 23'u16),
    (7_372_800, 28800,   AsyncNormal, 15'u16),
    (7_372_800, 38400,   AsyncNormal, 11'u16),
    (7_372_800, 57600,   AsyncNormal, 7'u16),
    (7_372_800, 76800,   AsyncNormal, 5'u16),
    (7_372_800, 115200,  AsyncNormal, 3'u16),
    (7_372_800, 230400,  AsyncNormal, 1'u16),
    (7_372_800, 250000,  AsyncNormal, 1'u16),
    (7_372_800, 500000,  AsyncNormal, 0'u16),
    (7_372_800, 2400,    AsyncDouble, 383'u16),
    (7_372_800, 4800,    AsyncDouble, 191'u16),
    (7_372_800, 9600,    AsyncDouble, 95'u16),
    (7_372_800, 14400,   AsyncDouble, 63'u16),
    (7_372_800, 19200,   AsyncDouble, 47'u16),
    (7_372_800, 28800,   AsyncDouble, 31'u16),
    (7_372_800, 38400,   AsyncDouble, 23'u16),
    (7_372_800, 57600,   AsyncDouble, 15'u16),
    (7_372_800, 76800,   AsyncDouble, 11'u16),
    (7_372_800, 115200,  AsyncDouble, 7'u16),
    (7_372_800, 230400,  AsyncDouble, 3'u16),
    (7_372_800, 250000,  AsyncDouble, 3'u16),
    (7_372_800, 500000,  AsyncDouble, 1'u16),
    (7_372_800, 1000000, AsyncDouble, 0'u16),

    # Table 19-11: f_osc = 8.0000MHz
    (8_000_000, 2400,    AsyncNormal, 207'u16),
    (8_000_000, 4800,    AsyncNormal, 103'u16),
    (8_000_000, 9600,    AsyncNormal, 51'u16),
    (8_000_000, 14400,   AsyncNormal, 34'u16),
    (8_000_000, 19200,   AsyncNormal, 25'u16),
    (8_000_000, 28800,   AsyncNormal, 16'u16),
    (8_000_000, 38400,   AsyncNormal, 12'u16),
    (8_000_000, 57600,   AsyncNormal, 8'u16),
    (8_000_000, 76800,   AsyncNormal, 6'u16),
    (8_000_000, 115200,  AsyncNormal, 3'u16),
    (8_000_000, 230400,  AsyncNormal, 1'u16),
    (8_000_000, 250000,  AsyncNormal, 1'u16),
    (8_000_000, 500000,  AsyncNormal, 0'u16),
    (8_000_000, 2400,    AsyncDouble, 416'u16),
    (8_000_000, 4800,    AsyncDouble, 207'u16),
    (8_000_000, 9600,    AsyncDouble, 103'u16),
    (8_000_000, 14400,   AsyncDouble, 68'u16),
    (8_000_000, 19200,   AsyncDouble, 51'u16),
    (8_000_000, 28800,   AsyncDouble, 34'u16),
    (8_000_000, 38400,   AsyncDouble, 25'u16),
    (8_000_000, 57600,   AsyncDouble, 16'u16),
    (8_000_000, 76800,   AsyncDouble, 12'u16),
    (8_000_000, 115200,  AsyncDouble, 8'u16),
    (8_000_000, 230400,  AsyncDouble, 3'u16),
    (8_000_000, 250000,  AsyncDouble, 3'u16),
    (8_000_000, 500000,  AsyncDouble, 1'u16),
    (8_000_000, 1000000, AsyncDouble, 0'u16),

    # Table 19-11: f_osc = 11.0592MHz
    (11_059_200, 2400,    AsyncNormal, 287'u16),
    (11_059_200, 4800,    AsyncNormal, 143'u16),
    (11_059_200, 9600,    AsyncNormal, 71'u16),
    (11_059_200, 14400,   AsyncNormal, 47'u16),
    (11_059_200, 19200,   AsyncNormal, 35'u16),
    (11_059_200, 28800,   AsyncNormal, 23'u16),
    (11_059_200, 38400,   AsyncNormal, 17'u16),
    (11_059_200, 57600,   AsyncNormal, 11'u16),
    (11_059_200, 76800,   AsyncNormal, 8'u16),
    (11_059_200, 115200,  AsyncNormal, 5'u16),
    (11_059_200, 230400,  AsyncNormal, 2'u16),
    (11_059_200, 250000,  AsyncNormal, 2'u16),
    (11_059_200, 2400,    AsyncDouble, 575'u16),
    (11_059_200, 4800,    AsyncDouble, 287'u16),
    (11_059_200, 9600,    AsyncDouble, 143'u16),
    (11_059_200, 14400,   AsyncDouble, 95'u16),
    (11_059_200, 19200,   AsyncDouble, 71'u16),
    (11_059_200, 28800,   AsyncDouble, 47'u16),
    (11_059_200, 38400,   AsyncDouble, 35'u16),
    (11_059_200, 57600,   AsyncDouble, 23'u16),
    (11_059_200, 76800,   AsyncDouble, 17'u16),
    (11_059_200, 115200,  AsyncDouble, 11'u16),
    (11_059_200, 230400,  AsyncDouble, 5'u16),
    (11_059_200, 250000,  AsyncDouble, 5'u16),
    (11_059_200, 500000,  AsyncDouble, 2'u16),

    # Table 19-11: f_osc = 14.7456MHz
    (14_745_600, 2400,    AsyncNormal, 383'u16),
    (14_745_600, 4800,    AsyncNormal, 191'u16),
    (14_745_600, 9600,    AsyncNormal, 95'u16),
    (14_745_600, 14400,   AsyncNormal, 63'u16),
    (14_745_600, 19200,   AsyncNormal, 47'u16),
    (14_745_600, 28800,   AsyncNormal, 31'u16),
    (14_745_600, 38400,   AsyncNormal, 23'u16),
    (14_745_600, 57600,   AsyncNormal, 15'u16),
    (14_745_600, 76800,   AsyncNormal, 11'u16),
    (14_745_600, 115200,  AsyncNormal, 7'u16),
    (14_745_600, 230400,  AsyncNormal, 3'u16),
    (14_745_600, 250000,  AsyncNormal, 3'u16),
    (14_745_600, 500000,  AsyncNormal, 1'u16),
    (14_745_600, 2400,    AsyncDouble, 767'u16),
    (14_745_600, 4800,    AsyncDouble, 383'u16),
    (14_745_600, 9600,    AsyncDouble, 191'u16),
    (14_745_600, 14400,   AsyncDouble, 127'u16),
    (14_745_600, 19200,   AsyncDouble, 95'u16),
    (14_745_600, 28800,   AsyncDouble, 63'u16),
    (14_745_600, 38400,   AsyncDouble, 47'u16),
    (14_745_600, 57600,   AsyncDouble, 31'u16),
    (14_745_600, 76800,   AsyncDouble, 23'u16),
    (14_745_600, 115200,  AsyncDouble, 15'u16),
    (14_745_600, 230400,  AsyncDouble, 7'u16),
    (14_745_600, 250000,  AsyncDouble, 6'u16),
    (14_745_600, 500000,  AsyncDouble, 3'u16),
    (14_745_600, 1000000, AsyncDouble, 1'u16),

    # Table 19-12: f_osc = 16.0000MHz
    (16_000_000, 2400,    AsyncNormal, 416'u16),
    (16_000_000, 4800,    AsyncNormal, 207'u16),
    (16_000_000, 9600,    AsyncNormal, 103'u16),
    (16_000_000, 14400,   AsyncNormal, 68'u16),
    (16_000_000, 19200,   AsyncNormal, 51'u16),
    (16_000_000, 28800,   AsyncNormal, 34'u16),
    (16_000_000, 38400,   AsyncNormal, 25'u16),
    (16_000_000, 57600,   AsyncNormal, 16'u16),
    (16_000_000, 76800,   AsyncNormal, 12'u16),
    (16_000_000, 115200,  AsyncNormal, 8'u16),
    (16_000_000, 230400,  AsyncNormal, 3'u16),
    (16_000_000, 250000,  AsyncNormal, 3'u16),
    (16_000_000, 500000,  AsyncNormal, 1'u16),
    (16_000_000, 1000000, AsyncNormal, 0'u16),
    (16_000_000, 2400,    AsyncDouble, 832'u16),
    (16_000_000, 4800,    AsyncDouble, 416'u16),
    (16_000_000, 9600,    AsyncDouble, 207'u16),
    (16_000_000, 14400,   AsyncDouble, 138'u16),
    (16_000_000, 19200,   AsyncDouble, 103'u16),
    (16_000_000, 28800,   AsyncDouble, 68'u16),
    (16_000_000, 38400,   AsyncDouble, 51'u16),
    (16_000_000, 57600,   AsyncDouble, 34'u16),
    (16_000_000, 76800,   AsyncDouble, 25'u16),
    (16_000_000, 115200,  AsyncDouble, 16'u16),
    (16_000_000, 230400,  AsyncDouble, 8'u16),
    (16_000_000, 250000,  AsyncDouble, 7'u16),
    (16_000_000, 500000,  AsyncDouble, 3'u16),
    (16_000_000, 1000000, AsyncDouble, 1'u16),
  ]


  result = newStmtList()
  for test in test_cases:
    let freq = newLit(test[0])
    let baud = newLit(test[1])
    let mode = newLit(test[2])
    let exp  = newLit(test[3])
    result.add quote do:
      check baudRate(`baud`, `freq`, `mode`) == `exp`

suite "usart tests":
  test "baud rates":
    baudTests()

